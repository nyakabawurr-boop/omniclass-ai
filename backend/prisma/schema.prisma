// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  STUDENT
  INSTRUCTOR
  ADMIN
}

enum SubscriptionType {
  STUDENT
  INSTRUCTOR
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

enum PaymentMethod {
  ECOCASH
  ONEMONEY
  OMARI
  BANK_CARD
  BANK_TRANSFER
}

enum PaymentStatus {
  PENDING
  COMPLETED
  FAILED
  REFUNDED
}

enum EducationLevel {
  ORDINARY
  ADVANCED
}

enum VideoSessionStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum AssessmentType {
  EXERCISE
  QUIZ
  EXAM
}

enum MessageRole {
  USER
  ASSISTANT
}

model User {
  id              String    @id @default(uuid())
  email           String    @unique
  passwordHash    String
  firstName       String
  lastName        String
  role            UserRole  @default(STUDENT)
  isEmailVerified Boolean   @default(false)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  subscriptions       Subscription[]
  payments            Payment[]
  chatSessions        ChatSession[]
  videoSessions       VideoSession[]
  instructorProfile   InstructorProfile?
  instructorMaterials InstructorMaterial[]
  aiAgentConfigs      AIAgentConfig[]
  lessonPlans         LessonPlan[]
  schemesOfWork       SchemeOfWork[]
  assessments         Assessment[]
  uploadedFiles       UploadedFile[]

  @@index([email])
  @@index([role])
}

model Subscription {
  id            String             @id @default(uuid())
  userId        String
  type          SubscriptionType
  status        SubscriptionStatus @default(ACTIVE)
  startDate     DateTime           @default(now())
  endDate       DateTime
  billingPeriod String             @default("monthly")
  amount        Decimal            @db.Decimal(10, 2)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  payments Payment[]

  @@index([userId])
  @@index([status])
}

model Payment {
  id              String        @id @default(uuid())
  subscriptionId  String
  userId          String
  amount          Decimal       @db.Decimal(10, 2)
  currency        String        @default("USD")
  paymentMethod   PaymentMethod
  status          PaymentStatus @default(PENDING)
  transactionId   String?       @unique
  paymentReference String?
  metadata        Json?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  subscription Subscription @relation(fields: [subscriptionId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([subscriptionId])
  @@index([status])
  @@index([transactionId])
}

model Subject {
  id          String      @id @default(uuid())
  name        String
  level       EducationLevel
  description String?
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  syllabi            Syllabus[]
  aiAgentConfigs     AIAgentConfig[]
  chatSessions       ChatSession[]
  videoSessions      VideoSession[]
  instructorMaterials InstructorMaterial[]
  lessonPlans       LessonPlan[]
  schemesOfWork     SchemeOfWork[]
  assessments       Assessment[]

  @@index([level])
  @@index([isActive])
}

model Syllabus {
  id        String   @id @default(uuid())
  subjectId String
  title     String
  content   Json     // Structured syllabus data
  version   String   @default("1.0")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@index([subjectId])
}

model AIAgentConfig {
  id          String   @id @default(uuid())
  subjectId   String
  instructorId String? // null for default system agents
  systemPrompt String  @db.Text
  temperature  Float    @default(0.7)
  maxTokens    Int      @default(2000)
  model        String   @default("gpt-4")
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  subject       Subject       @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  instructor    User?         @relation(fields: [instructorId], references: [id], onDelete: SetNull)
  chatSessions  ChatSession[]
  videoSessions VideoSession[]

  @@index([subjectId])
  @@index([instructorId])
}

model ChatSession {
  id           String   @id @default(uuid())
  userId       String
  subjectId    String
  agentConfigId String
  title        String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject      Subject       @relation(fields: [subjectId], references: [id])
  agentConfig  AIAgentConfig @relation(fields: [agentConfigId], references: [id])
  messages     ChatMessage[]

  @@index([userId])
  @@index([subjectId])
}

model ChatMessage {
  id         String      @id @default(uuid())
  sessionId  String
  role       MessageRole
  content    String      @db.Text
  attachments Json?      // Array of file references
  createdAt  DateTime    @default(now())

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([createdAt])
}

model VideoSession {
  id           String            @id @default(uuid())
  userId       String
  subjectId    String
  agentConfigId String
  question     String            @db.Text
  videoUrl     String?
  textSummary  String            @db.Text
  script       Json?             // Generated script for video
  status       VideoSessionStatus @default(PENDING)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject     Subject       @relation(fields: [subjectId], references: [id])
  agentConfig AIAgentConfig @relation(fields: [agentConfigId], references: [id])

  @@index([userId])
  @@index([subjectId])
  @@index([status])
}

model InstructorProfile {
  id            String   @id @default(uuid())
  userId        String   @unique
  bio           String?  @db.Text
  qualifications String? @db.Text
  subjects      Json     // Array of subject IDs
  levels        Json     // Array of levels
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model InstructorMaterial {
  id          String   @id @default(uuid())
  instructorId String
  subjectId   String?
  title       String
  description String?  @db.Text
  fileUrl     String
  fileType    String
  fileSize    Int
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  instructor User     @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  subject    Subject? @relation(fields: [subjectId], references: [id], onDelete: SetNull)

  @@index([instructorId])
  @@index([subjectId])
}

model LessonPlan {
  id         String         @id @default(uuid())
  instructorId String
  subjectId  String
  level      EducationLevel
  title      String
  topic      String
  date       DateTime?
  week       Int?
  objectives Json           // Array of learning objectives
  resources  Json           // Array of resource references
  activities Json           // Array of activity descriptions
  content    String         @db.Text
  createdAt  DateTime       @default(now())
  updatedAt  DateTime       @updatedAt

  instructor User    @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  subject    Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@index([instructorId])
  @@index([subjectId])
}

model SchemeOfWork {
  id          String         @id @default(uuid())
  instructorId String
  subjectId   String
  level       EducationLevel
  title       String
  term        String?
  year        Int
  schedule    Json           // Array of weekly/topic breakdowns
  content     String         @db.Text
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  instructor User    @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  subject    Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@index([instructorId])
  @@index([subjectId])
}

model Assessment {
  id          String         @id @default(uuid())
  instructorId String
  subjectId   String
  level       EducationLevel
  title       String
  type        AssessmentType
  topic       String?
  questions   Json           // Array of question objects
  answerKey   Json?          // Answer key
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  instructor User    @relation(fields: [instructorId], references: [id], onDelete: Cascade)
  subject    Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)

  @@index([instructorId])
  @@index([subjectId])
  @@index([type])
}

model UploadedFile {
  id          String   @id @default(uuid())
  userId      String
  fileName    String
  originalName String
  fileUrl     String
  fileType    String
  fileSize    Int
  mimeType    String
  context     String?  // Where it's used
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([context])
}

